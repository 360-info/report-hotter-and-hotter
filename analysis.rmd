---
title: ""
author: "James Goldie, 360info"
---

```{r setup}
library(tidyverse)
library(janitor)
library(lubridate)
library(mosaic)
library(glue)
library(ggtext)
library(here)
```

```{r import}

# pipe fn to import surveys and do light tidying
import_survey <- . %>%
  {
    read_csv(here("data", .), na = c("", "NA", "N/A", "N / A"),
      col_types = cols(
        "OptIn Date" = col_date(format = "%d/%m/%Y"),
        HoursDay = col_integer(),
        Rooms = col_integer(),
        Windows = col_integer(),
        "People in House" = col_number(),
        Temperature = col_number(),
        "Temperature (C)" = col_number(),
        "Relative Humidity" = col_number(),
        "Heat Index" = col_number(),
        "Heat Index (C)" = col_number(),
        .default = col_factor(NULL, include_na = TRUE)
    ))
  } %>%
  clean_names() %>%
  slice(-n()) %>%
  select(-starts_with("x1")) %>%
  # normalise col names for weather in some surveys
  rename_with(~ str_replace(.x, "_c$", ""), .cols = ends_with("_c"))

indonesia <- import_survey("Heat-Covid Nexus Survey_Indonesia.csv")
india     <- import_survey("Heat-Covid Nexus Survey_India.csv")
pakistan  <- import_survey("Heat-Covid Nexus Survey_Pakistan.csv")
cameroon  <- import_survey("Heat-Covid Nexus Survey_Cameroon.csv")

# here's a fn to see wha tthe unique values of our categorical columns are
get_factor_values <- . %>%
  summarise(across(
    where(is.factor),
    list(
      n = ~ length(levels(.x)),
      # could also pivot longer so that there's a row for each level...
      pos_values = ~ paste(levels(.x), collapse = "|")),
    .names = "{.col}-{.fn}"
    )) %>%
  pivot_longer(everything(), names_to = c("col_name", ".value"),
    names_sep = "-")

get_factor_values(indonesia) %>% print(n = Inf)
```

```{r }

test_cols <- function(x, col1, col2) {

}

cameroon %>%
  select(use_fan, experience_headache) %>%
  mutate(use_fan = fct_explicit_na(use_fan, na_level = "No")) ->
test_numbers

indonesia %>%
  select(hours_day, experience_headache) %>%
  mutate(
    hours_day = case_when(
      hours_day <= 12 ~ "Half the day or less",
      hours_day <= 24 ~ "More than half the day",
      hours_day > 24 ~ NA_character_),
    experience_headache = fct_drop(experience_headache)) ->
test_numbers

test_numbers %>%
  count(hours_day, experience_headache) %>%
  # now count stats per group so we can feed them into ggplot2
  group_by(hours_day) %>%
  mutate(
    predictor_n = sum(n),
    predictor_prop = n / predictor_n) ->
test_numbers_vis

# manually build contingency table to ensure we're consistent in answering
# "people w/ X disadvantage were Y% more/less likely to experience Z bad outcome"
build_2x2 <- function(df, bad_outcome, good_outcome, disadvantage, advantage) {

  contingency_table <- data.frame(
    bad_outcome = c(
      df %>% filter({{ bad_outcome }}, {{ advantage }}) %>% pull(n),
      df %>% filter({{ bad_outcome }}, {{ disadvantage }}) %>% pull(n)),
    good_outcome = c(
      df %>% filter({{ good_outcome }}, {{ advantage }}) %>% pull(n),
      df %>% filter({{ good_outcome }}, {{ disadvantage }}) %>% pull(n)))

  rownames(contingency_table) <- c("advantage", "disadvantage")
  return(contingency_table)
}

# calc the relative risk of bad_outcome given disadvantage compared to advantage
test_numbers_vis %>%
  build_2x2(
    bad_outcome = experience_headache == "Yes",
    good_outcome = experience_headache == "No",
    disadvantage = hours_day == "Half the day or less",
    advantage = hours_day == "More than half the day") %>%
  orrr() ->
test_numbers_risk

# labelling functions
label_risk <- function(x) {
  pct_risk <- scales::percent(abs(x - 1))
  moreless <- ifelse(x > 1, "more", "less")
  paste(pct_risk, moreless, "likely")
}
label_range <- function(x) {
  paste(
    scales::percent(attr(x, "lower.RR")), "to",
    scales::percent(attr(x, "upper.RR")))
}
rr_statsig <- function(x) {
  !between(1, attr(x, "lower.RR"), attr(x, "upper.RR"))
}

test_numbers_vis %>%
  filter(experience_headache == "Yes") %>%
  {
    ggplot(.) +
      aes(y = predictor_prop, x = hours_day, fill = experience_headache) +
      geom_col() +
      geom_richtext(
        aes(label = glue(
          "**{scales::percent(predictor_prop)} of respondents**<br>",
          "({n} of {predictor_n} surveyed)")),
        colour = "white", fill = NA, label.colour = NA,
        hjust = "inward", nudge_y = -0.00125, size = 5) +
      scale_y_continuous(labels = scales::label_percent()) +
      coord_flip() +
      labs(
        title = "Electricty and headaches in Indonesia",
        subtitles = glue(
          "{if_else(rr_statsig(test_numbers_risk), '☑️', '❌')} ",
          "People with <= 12 hrs electricty a day were ",
          "{label_risk(attr(test_numbers_risk, 'RR'))} ",
          "to experience a headache than non-fan users. ",
          "(RR: {label_range(test_numbers_risk)})"))
  }

```


These surveys do have some minor differences in columns that will require cleaning if we're to analyse them all together:

```{r combinecountries}

select_interesting_rows <- .
  select(
    country, opt_in_date, gender, occupation_coded, own_house, cool_home,
    electricty, hours_day, drinking_water, rooms, ends_with("material"),
    windows, people_in_house, normally_do_coded, add_ventilation, )

# some columns don't appear in all four countries:
all_countries <- bind_rows(
  indonesia, india %>% select(-electricity), pakistan, cameroon
)

# columns that don't appear in all four countries
# adm*, language, sindh, liitoral, occupation_translated, normally_do_translated, yes_pandemic_change_translated

# [1] "occupation_coded"                   "normally_do_coded"
# [3] "yes_pandemic_change_coded_general"  "yes_pandemic_change_coded_specific"

# also some columns import as different types unless i specify them all!
# (all india's $electricty are NA, so it comes in double)
```